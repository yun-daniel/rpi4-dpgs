// RGB LED Matrix Display - Kernel Module Í∏∞Î∞ò Íµ¨Ï°∞ with Î∞òÎ≥µ Î†åÎçîÎßÅ ÏßÄÏõê

#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/fs.h>
#include <linux/uaccess.h>
#include <linux/io.h>
#include <linux/delay.h>
#include <linux/cdev.h>
#include <linux/workqueue.h>

#define DEVICE_NAME "rgbmatrix"
#define GPIO_BASE_ADDR 0xFE200000
#define GPIO_LEN       0xB4

#define WIDTH 64
#define HEIGHT 32

#define R1 11
#define G1 27
#define B1 7
#define R2 8
#define G2 9
#define B2 10
#define A  22
#define B  23
#define C  24
#define D  25
#define CLK 17
#define LAT 4
#define OE  18

#define MAX_COORDS 20
#define MAX_FIXED_COORDS 400

#define MAJOR_NUM 260

#define CUR_FB framebuffer[active_buf]
#define BACK_FB framebuffer[1 - active_buf]


static ssize_t rgbmatrixWrite(struct file *file, const char __user *buf, size_t len, loff_t *offset);

static struct file_operations fops = {
    .owner = THIS_MODULE,
    .write = rgbmatrixWrite,
};

typedef uint8_t u8;
typedef uint16_t u16;

struct Pixel {
    u8 x;
    u8 y;
};

struct Slot {
    u8 state;
    u8 num_coords;
    struct Pixel coords[MAX_COORDS];
};

struct FixedSlot {
    u8 state;
    u16 num_coords;
    struct Pixel coords[MAX_FIXED_COORDS];
};

static struct Slot slots[] = {
    {0, 20, {{58,21}, {59,21}, {60,21}, {61,21}, {62,21}, {58,22}, {59,22}, {60,22}, {61,22}, {62,22}, {58,23}, {59,23}, {60,23}, {61,23}, {62,23}, {58,24}, {59,24}, {60,24}, {61,24}, {62,24}}},
    {0, 20, {{58,16}, {59,16}, {60,16}, {61,16}, {62,16}, {58,17}, {59,17}, {60,17}, {61,17}, {62,17}, {58,18}, {59,18}, {60,18}, {61,18}, {62,18}, {58,19}, {59,19}, {60,19}, {61,19}, {62,19}}},
    {0, 20, {{58,11}, {59,11}, {60,11}, {61,11}, {62,11}, {58,12}, {59,12}, {60,12}, {61,12}, {62,12}, {58,13}, {59,13}, {60,13}, {61,13}, {62,13}, {58,14}, {59,14}, {60,14}, {61,14}, {62,14}}},
    {0, 20, {{58,6}, {59,6}, {60,6}, {61,6}, {62,6}, {58,7}, {59,7}, {60,7}, {61,7}, {62,7}, {58,8}, {59,8}, {60,8}, {61,8}, {62,8}, {58,9}, {59,9}, {60,9}, {61,9}, {62,9}}},
    {0, 20, {{45,1}, {46,1}, {47,1}, {48,1}, {45,2}, {46,2}, {47,2}, {48,2}, {45,3}, {46,3}, {47,3}, {48,3}, {45,4}, {46,4}, {47,4}, {48,4}, {45,5}, {46,5}, {47,5}, {48,5}}},
    {0, 20, {{40,1}, {41,1}, {42,1}, {43,1}, {40,2}, {41,2}, {42,2}, {43,2}, {40,3}, {41,3}, {42,3}, {43,3}, {40,4}, {41,4}, {42,4}, {43,4}, {40,5}, {41,5}, {42,5}, {43,5}}},
    {0, 20, {{35,1}, {36,1}, {37,1}, {38,1}, {35,2}, {36,2}, {37,2}, {38,2}, {35,3}, {36,3}, {37,3}, {38,3}, {35,4}, {36,4}, {37,4}, {38,4}, {35,5}, {36,5}, {37,5}, {38,5}}},
    {0, 20, {{30,1}, {31,1}, {32,1}, {33,1}, {30,2}, {31,2}, {32,2}, {33,2}, {30,3}, {31,3}, {32,3}, {33,3}, {30,4}, {31,4}, {32,4}, {33,4}, {30,5}, {31,5}, {32,5}, {33,5}}},
    {0, 20, {{25,1}, {26,1}, {27,1}, {28,1}, {25,2}, {26,2}, {27,2}, {28,2}, {25,3}, {26,3}, {27,3}, {28,3}, {25,4}, {26,4}, {27,4}, {28,4}, {25,5}, {26,5}, {27,5}, {28,5}}},
    {0, 20, {{20,1}, {21,1}, {22,1}, {23,1}, {20,2}, {21,2}, {22,2}, {23,2}, {20,3}, {21,3}, {22,3}, {23,3}, {20,4}, {21,4}, {22,4}, {23,4}, {20,5}, {21,5}, {22,5}, {23,5}}},
    {0, 20, {{15,1}, {16,1}, {17,1}, {18,1}, {15,2}, {16,2}, {17,2}, {18,2}, {15,3}, {16,3}, {17,3}, {18,3}, {15,4}, {16,4}, {17,4}, {18,4}, {15,5}, {16,5}, {17,5}, {18,5}}},
    {0, 20, {{1,6}, {2,6}, {3,6}, {4,6}, {5,6}, {1,7}, {2,7}, {3,7}, {4,7}, {5,7}, {1,8}, {2,8}, {3,8}, {4,8}, {5,8}, {1,9}, {2,9}, {3,9}, {4,9}, {5,9}}},
    {0, 20, {{1,11}, {2,11}, {3,11}, {4,11}, {5,11}, {1,12}, {2,12}, {3,12}, {4,12}, {5,12}, {1,13}, {2,13}, {3,13}, {4,13}, {5,13}, {1,14}, {2,14}, {3,14}, {4,14}, {5,14}}},
    {0, 20, {{1,16}, {2,16}, {3,16}, {4,16}, {5,16}, {1,17}, {2,17}, {3,17}, {4,17}, {5,17}, {1,18}, {2,18}, {3,18}, {4,18}, {5,18}, {1,19}, {2,19}, {3,19}, {4,19}, {5,19}}},
    {0, 20, {{1,21}, {2,21}, {3,21}, {4,21}, {5,21}, {1,22}, {2,22}, {3,22}, {4,22}, {5,22}, {1,23}, {2,23}, {3,23}, {4,23}, {5,23}, {1,24}, {2,24}, {3,24}, {4,24}, {5,24}}},
    {0, 20, {{45,13}, {46,13}, {47,13}, {48,13}, {45,14}, {46,14}, {47,14}, {48,14}, {45,15}, {46,15}, {47,15}, {48,15}, {45,16}, {46,16}, {47,16}, {48,16}, {45,17}, {46,17}, {47,17}, {48,17}}},
    {0, 20, {{40,13}, {41,13}, {42,13}, {43,13}, {40,14}, {41,14}, {42,14}, {43,14}, {40,15}, {41,15}, {42,15}, {43,15}, {40,16}, {41,16}, {42,16}, {43,16}, {40,17}, {41,17}, {42,17}, {43,17}}},
    {0, 20, {{35,13}, {36,13}, {37,13}, {38,13}, {35,14}, {36,14}, {37,14}, {38,14}, {35,15}, {36,15}, {37,15}, {38,15}, {35,16}, {36,16}, {37,16}, {38,16}, {35,17}, {36,17}, {37,17}, {38,17}}},
    {0, 20, {{30,13}, {31,13}, {32,13}, {33,13}, {30,14}, {31,14}, {32,14}, {33,14}, {30,15}, {31,15}, {32,15}, {33,15}, {30,16}, {31,16}, {32,16}, {33,16}, {30,17}, {31,17}, {32,17}, {33,17}}},
    {0, 20, {{25,13}, {26,13}, {27,13}, {28,13}, {25,14}, {26,14}, {27,14}, {28,14}, {25,15}, {26,15}, {27,15}, {28,15}, {25,16}, {26,16}, {27,16}, {28,16}, {25,17}, {26,17}, {27,17}, {28,17}}},
    {0, 20, {{20,13}, {21,13}, {22,13}, {23,13}, {20,14}, {21,14}, {22,14}, {23,14}, {20,15}, {21,15}, {22,15}, {23,15}, {20,16}, {21,16}, {22,16}, {23,16}, {20,17}, {21,17}, {22,17}, {23,17}}},
    {0, 20, {{15,13}, {16,13}, {17,13}, {18,13}, {15,14}, {16,14}, {17,14}, {18,14}, {15,15}, {16,15}, {17,15}, {18,15}, {15,16}, {16,16}, {17,16}, {18,16}, {15,17}, {16,17}, {17,17}, {18,17}}},
    {0, 20, {{15,19}, {16,19}, {17,19}, {18,19}, {15,20}, {16,20}, {17,20}, {18,20}, {15,21}, {16,21}, {17,21}, {18,21}, {15,22}, {16,22}, {17,22}, {18,22}, {15,23}, {16,23}, {17,23}, {18,23}}},
    {0, 20, {{20,19}, {21,19}, {22,19}, {23,19}, {20,20}, {21,20}, {22,20}, {23,20}, {20,21}, {21,21}, {22,21}, {23,21}, {20,22}, {21,22}, {22,22}, {23,22}, {20,23}, {21,23}, {22,23}, {23,23}}},
    {0, 20, {{25,19}, {26,19}, {27,19}, {28,19}, {25,20}, {26,20}, {27,20}, {28,20}, {25,21}, {26,21}, {27,21}, {28,21}, {25,22}, {26,22}, {27,22}, {28,22}, {25,23}, {26,23}, {27,23}, {28,23}}},
    {0, 20, {{30,19}, {31,19}, {32,19}, {33,19}, {30,20}, {31,20}, {32,20}, {33,20}, {30,21}, {31,21}, {32,21}, {33,21}, {30,22}, {31,22}, {32,22}, {33,22}, {30,23}, {31,23}, {32,23}, {33,23}}},
    {0, 20, {{35,19}, {36,19}, {37,19}, {38,19}, {35,20}, {36,20}, {37,20}, {38,20}, {35,21}, {36,21}, {37,21}, {38,21}, {35,22}, {36,22}, {37,22}, {38,22}, {35,23}, {36,23}, {37,23}, {38,23}}},
    {0, 20, {{40,19}, {41,19}, {42,19}, {43,19}, {40,20}, {41,20}, {42,20}, {43,20}, {40,21}, {41,21}, {42,21}, {43,21}, {40,22}, {41,22}, {42,22}, {43,22}, {40,23}, {41,23}, {42,23}, {43,23}}},
    {0, 20, {{45,19}, {46,19}, {47,19}, {48,19}, {45,20}, {46,20}, {47,20}, {48,20}, {45,21}, {46,21}, {47,21}, {48,21}, {45,22}, {46,22}, {47,22}, {48,22}, {45,23}, {46,23}, {47,23}, {48,23}}},
};
static struct FixedSlot fixed_slots[] = {
   {4, 380, {{0,0}, {1,0}, {2,0}, {3,0}, {4,0}, {5,0}, {6,0}, {7,0}, {8,0}, {9,0}, {10,0}, {11,0}, {12,0}, {13,0}, {14,0}, {15,0}, {16,0}, {17,0}, {18,0}, {19,0}, {20,0}, {21,0}, {22,0}, {23,0}, {24,0}, {25,0}, {26,0}, {27,0}, {28,0}, {29,0}, {30,0}, {31,0}, {32,0}, {33,0}, {34,0}, {35,0}, {36,0}, {37,0}, {38,0}, {39,0}, {40,0}, {41,0}, {42,0}, {43,0}, {44,0}, {45,0}, {46,0}, {47,0}, {48,0}, {49,0}, {50,0}, {51,0}, {52,0}, {53,0}, {54,0}, {55,0}, {56,0}, {57,0}, {58,0}, {59,0}, {60,0}, {61,0}, {62,0}, {63,0}, {0,1}, {14,1}, {19,1}, {24,1}, {29,1}, {34,1}, {39,1}, {44,1}, {49,1}, {63,1}, {0,2}, {14,2}, {19,2}, {24,2}, {29,2}, {34,2}, {39,2}, {44,2}, {49,2}, {63,2}, {0,3}, {14,3}, {19,3}, {24,3}, {29,3}, {34,3}, {39,3}, {44,3}, {49,3}, {63,3}, {0,4}, {14,4}, {19,4}, {24,4}, {29,4}, {34,4}, {39,4}, {44,4}, {49,4}, {63,4}, {0,5}, {1,5}, {2,5}, {3,5}, {4,5}, {5,5}, {14,5}, {19,5}, {24,5}, {29,5}, {34,5}, {39,5}, {44,5}, {49,5}, {58,5}, {59,5}, {60,5}, {61,5}, {62,5}, {63,5}, {0,6}, {63,6}, {0,7}, {63,7}, {0,8}, {63,8}, {0,9}, {63,9}, {0,10}, {1,10}, {2,10}, {3,10}, {4,10}, {5,10}, {58,10}, {59,10}, {60,10}, {61,10}, {62,10}, {63,10}, {0,11}, {63,11}, {0,12}, {63,12}, {0,13}, {14,13}, {19,13}, {24,13}, {29,13}, {34,13}, {39,13}, {44,13}, {49,13}, {63,13}, {0,14}, {14,14}, {19,14}, {24,14}, {29,14}, {34,14}, {39,14}, {44,14}, {49,14}, {63,14}, {0,15}, {1,15}, {2,15}, {3,15}, {4,15}, {5,15}, {14,15}, {19,15}, {24,15}, {29,15}, {34,15}, {39,15}, {44,15}, {49,15}, {58,15}, {59,15}, {60,15}, {61,15}, {62,15}, {63,15}, {0,16}, {14,16}, {19,16}, {24,16}, {29,16}, {34,16}, {39,16}, {44,16}, {49,16}, {63,16}, {0,17}, {14,17}, {19,17}, {24,17}, {29,17}, {34,17}, {39,17}, {44,17}, {49,17}, {63,17}, {0,18}, {14,18}, {15,18}, {16,18}, {17,18}, {18,18}, {19,18}, {20,18}, {21,18}, {22,18}, {23,18}, {24,18}, {25,18}, {26,18}, {27,18}, {28,18}, {29,18}, {30,18}, {31,18}, {32,18}, {33,18}, {34,18}, {35,18}, {36,18}, {37,18}, {38,18}, {39,18}, {40,18}, {41,18}, {42,18}, {43,18}, {44,18}, {45,18}, {46,18}, {47,18}, {48,18}, {49,18}, {63,18}, {0,19}, {14,19}, {19,19}, {24,19}, {29,19}, {34,19}, {39,19}, {44,19}, {49,19}, {63,19}, {0,20}, {1,20}, {2,20}, {3,20}, {4,20}, {5,20}, {14,20}, {19,20}, {24,20}, {29,20}, {34,20}, {39,20}, {44,20}, {49,20}, {58,20}, {59,20}, {60,20}, {61,20}, {62,20}, {63,20}, {0,21}, {14,21}, {19,21}, {24,21}, {29,21}, {34,21}, {39,21}, {44,21}, {49,21}, {63,21}, {0,22}, {14,22}, {19,22}, {24,22}, {29,22}, {34,22}, {39,22}, {44,22}, {49,22}, {63,22}, {0,23}, {14,23}, {19,23}, {24,23}, {29,23}, {34,23}, {39,23}, {44,23}, {49,23}, {63,23}, {0,24}, {63,24}, {0,25}, {1,25}, {2,25}, {3,25}, {4,25}, {5,25}, {58,25}, {59,25}, {60,25}, {61,25}, {62,25}, {63,25}, {0,26}, {63,26}, {0,27}, {63,27}, {0,28}, {63,28}, {0,29}, {63,29}, {0,30}, {1,30}, {2,30}, {3,30}, {4,30}, {5,30}, {6,30}, {7,30}, {8,30}, {9,30}, {10,30}, {11,30}, {12,30}, {13,30}, {14,30}, {15,30}, {16,30}, {17,30}, {18,30}, {19,30}, {20,30}, {21,30}, {22,30}, {23,30}, {24,30}, {25,30}, {42,30}, {43,30}, {44,30}, {45,30}, {46,30}, {47,30}, {48,30}, {49,30}, {50,30}, {51,30}, {52,30}, {53,30}, {54,30}, {55,30}, {56,30}, {57,30}, {58,30}, {59,30}, {60,30}, {61,30}, {62,30}, {63,30}, {24,31}, {25,31}, {42,31}, {43,31}}},
   {5, 60, {{10,9}, {11,9}, {12,9}, {13,9}, {14,9}, {15,9}, {16,9}, {17,9}, {18,9}, {19,9}, {20,9}, {21,9}, {22,9}, {23,9}, {10,10}, {10,11}, {10,12}, {8,13}, {9,13}, {10,13}, {11,13}, {12,13}, {9,14}, {10,14}, {11,14}, {10,15}, {53,19}, {52,20}, {53,20}, {54,20}, {51,21}, {52,21}, {53,21}, {54,21}, {55,21}, {53,22}, {53,23}, {53,24}, {53,25}, {53,26}, {38,27}, {39,27}, {40,27}, {41,27}, {42,27}, {43,27}, {44,27}, {45,27}, {46,27}, {47,27}, {48,27}, {49,27}, {50,27}, {51,27}, {52,27}, {53,27}, {38,28}, {38,29}, {38,30}, {38,31}}}
};

static int slot_count = sizeof(slots) / sizeof(slots[0]);
static int fixed_slot_count = sizeof(fixed_slots) / sizeof(fixed_slots[0]);

static volatile uint32_t __iomem *gpio;
//
static uint8_t framebuffer[2][HEIGHT][WIDTH][3];
static int active_buf = 0;  // ÌòÑÏû¨ ÌôîÎ©¥ Ï∂úÎ†•Ïóê ÏÇ¨Ïö©ÎêòÎäî Î≤ÑÌçº
//
//static uint8_t framebuffer[HEIGHT][WIDTH][3];
//
static struct delayed_work draw_work;

static void setGpioOutput(int pin) {
    uint32_t reg = ioread32(&gpio[pin / 10]);
    reg &= ~(7 << ((pin % 10) * 3));
    reg |= (1 << ((pin % 10) * 3));
    iowrite32(reg, &gpio[pin / 10]);
}

static void gpioWrite(int pin, int value) {
    if (value)
        iowrite32(1 << pin, &gpio[7]);
    else
        iowrite32(1 << pin, &gpio[10]);
}

static void setMuxRow(uint8_t row) {
    gpioWrite(A, (row >> 0) & 1);
    gpioWrite(B, (row >> 1) & 1);
    gpioWrite(C, (row >> 2) & 1);
    gpioWrite(D, (row >> 3) & 1);
}

static void latchAndOutputEnable(void) {
    gpioWrite(LAT, 1);
    gpioWrite(LAT, 0);
    gpioWrite(OE, 0);
    udelay(3);
    gpioWrite(OE, 1);
}


static void shiftPixel(uint8_t r1, uint8_t g1, uint8_t b1,
                           uint8_t r2, uint8_t g2, uint8_t b2) {
    uint32_t set_mask = 0;
    uint32_t clr_mask = 0;

    if (r1) set_mask |= (1 << R1); else clr_mask |= (1 << R1);
    if (g1) set_mask |= (1 << G1); else clr_mask |= (1 << G1);
    if (b1) set_mask |= (1 << B1); else clr_mask |= (1 << B1);
    if (r2) set_mask |= (1 << R2); else clr_mask |= (1 << R2);
    if (g2) set_mask |= (1 << G2); else clr_mask |= (1 << G2);
    if (b2) set_mask |= (1 << B2); else clr_mask |= (1 << B2);

    iowrite32(clr_mask, &gpio[10]); // GPCLR0
    iowrite32(set_mask, &gpio[7]);  // GPSET0

    gpioWrite(CLK, 1);
    gpioWrite(CLK, 0);
}


static void drawSlot(struct Slot *slot, uint8_t r, uint8_t g, uint8_t b) {
    for (int i = 0; i < slot->num_coords; ++i) {
        int x = slot->coords[i].x;
        int y = slot->coords[i].y;
        if (x < WIDTH && y < HEIGHT) {
            BACK_FB[y][x][0] = r;
            BACK_FB[y][x][1] = g;
            BACK_FB[y][x][2] = b;
        }
    }
}


static void drawFixedSlot(struct FixedSlot *slot, uint8_t r, uint8_t g, uint8_t b) {
    for (int i = 0; i < slot->num_coords; ++i) {
        int x = slot->coords[i].x;
        int y = slot->coords[i].y;
        if (x < WIDTH && y < HEIGHT) {
            BACK_FB[y][x][0] = r;
            BACK_FB[y][x][1] = g;
            BACK_FB[y][x][2] = b;
        }
    }
}

static void applySlots(void) {
    memset(BACK_FB, 0, sizeof(framebuffer[0]));  // Ï£ºÏùò: ÌïòÎÇòÏùò Î≤ÑÌçºÎßå Ï¥àÍ∏∞Ìôî

    for (int i = 0; i < slot_count; ++i) {
        struct Slot *s = &slots[i];
        switch (s->state) {
            case 0: drawSlot(s, 0, 255, 0); break;
            case 1: drawSlot(s, 255, 0, 0); break;
            case 2: drawSlot(s, 255, 128, 0); break;
        }
    }

    for (int i = 0; i < fixed_slot_count; ++i) {
        struct FixedSlot *fs = &fixed_slots[i];
        switch (fs->state) {
            case 4: drawFixedSlot(fs, 255, 255, 255); break;
            case 5: drawFixedSlot(fs, 128, 128, 128); break;
        }
    }
}

static void drawFrame(void) {
    for (int repeat = 0; repeat < 6; ++repeat) {
        for (int row = 0; row < HEIGHT / 2; ++row) {
            gpioWrite(OE, 1);
            setMuxRow(row);
            for (int col = 0; col < WIDTH; ++col) {
                uint8_t *top = CUR_FB[row][col];
                uint8_t *bottom = CUR_FB[row + HEIGHT / 2][col];

                shiftPixel(top[0] > 127, top[1] > 127, top[2] > 127,
                        bottom[0] > 127, bottom[1] > 127, bottom[2] > 127);
            }
            latchAndOutputEnable();
        }
    }

    // üîÑ ÎßàÏßÄÎßâÏóê Î≤ÑÌçº ÌÜ†Í∏Ä
    active_buf ^= 1;
}

static ssize_t rgbmatrixWrite(struct file *file, const char __user *buf, size_t len, loff_t *offset) {
    char kbuf[16];
    if (len > sizeof(kbuf) - 1)
        return -EINVAL;

    if (copy_from_user(kbuf, buf, len))
        return -EFAULT;
    kbuf[len] = '\0';

    int index, state;
    if (sscanf(kbuf, "%d %d", &index, &state) != 2)
        return -EINVAL;

    if (index < 0 || index >= slot_count)
        return -EINVAL;

    slots[index].state = (u8)state;
    pr_info("[rgbmatrix] Slot[%d] state changed to %d\n", index, state);
    return len;
}

static void drawWorkHandler(struct work_struct *work) {
    applySlots();
    drawFrame();
    schedule_delayed_work(&draw_work, msecs_to_jiffies(10));
}

static int __init rgbmatrixInit(void) {
    void __iomem *gpio_base = ioremap(GPIO_BASE_ADDR, GPIO_LEN);
    if (!gpio_base) {
        pr_err("[rgbmatrix] Failed to map GPIO base\n");
        return -ENOMEM;
    }
    gpio = (volatile uint32_t __iomem *)gpio_base;

    int pins[] = {R1, G1, B1, R2, G2, B2, A, B, C, D, CLK, LAT, OE};
    for (int i = 0; i < sizeof(pins) / sizeof(pins[0]); ++i) {
        setGpioOutput(pins[i]);
    }

    INIT_DELAYED_WORK(&draw_work, drawWorkHandler);

    int ret = register_chrdev(MAJOR_NUM, DEVICE_NAME, &fops);
    if (ret < 0) {
        pr_err("[rgbmatrix] Failed to register char device\n");
        return ret;
    }

    schedule_delayed_work(&draw_work, msecs_to_jiffies(5));
    pr_info("[rgbmatrix] Draw loop scheduled\n");
    return 0;
}

static void __exit rgbmatrixExit(void) {
    cancel_delayed_work_sync(&draw_work);
    unregister_chrdev(MAJOR_NUM, DEVICE_NAME);
    if (gpio)
        iounmap((void __iomem *)gpio);
    pr_info("[rgbmatrix] Module exited\n");
}

module_init(rgbmatrixInit);
module_exit(rgbmatrixExit);

MODULE_LICENSE("GPL");
MODULE_AUTHOR("DPGS_VEDA");
MODULE_DESCRIPTION("RPI LED Matrix Display Kernel Module");